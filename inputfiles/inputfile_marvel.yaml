# ########################################################### #
# Pyxel detector simulation framework                         #
#                                                             #
# MARVEL CCD setup for PyEchelle simulations                  #
#                                                             #
# NOTE the following value are from the STA-1600 CCD model.   # 
# Area: 10.3k x 10.3k 9-Âµm pixels (95 x 95 mm image area)     #
# If not then otherwise stated below. Two read modes exist:   #
#                                                             #
# Fast readout (50 kHz):                                      #
# - Readout noise: 2 e-                                       #
# - 65.8 muV/DN -> 15198 DN/V -> 9.4 e/DN                     #
#                                                             #
# Slow readout (1 MHz):                                       #
# - Readout noise: 5 e-                                       #
# - 21.9 muV/DN -> 45662 DN/V -> 3.0 e/DN                     #
#                                                             #
# ########################################################### #

#--------------------------------------------------------------
exposure:
#--------------------------------------------------------------

  readout:
    non_destructive: true
    times: '[1]'

  outputs:
    output_folder: ""   # Will be overwritten
    save_data_to_file:
      - detector.image.array: ['fits']

#--------------------------------------------------------------
ccd_detector:
#--------------------------------------------------------------
# NOTE the following value are from the STA-1600 CCD model, and
# if not then otherwise stated below. Two read modes exist:
# Fast readout: 65.8 muV/DN -> 15198 DN/V -> 9.4 e/DN
# Slow readout: 21.9 muV/DN -> 45662 DN/V -> 3.0 e/DN

  geometry:

    row: 10560              # [pixel]
    col: 10560              # [pixel]
    total_thickness: 40.    # [micron] -> pyxel default
    pixel_vert_size: 9.     # [micron/pixel]
    pixel_horz_size: 9.     # [micron/pixel]

  material:
    material: 'silicon'

  environment:
    temperature: 200        # [K]

  characteristics:
    quantum_efficiency:        0.9         # QE approximation
    charge_to_volt_conversion: 7.0e-6      # [V/e] Charge readout sensitivity
    pre_amplification:         11          # [V/V] Gain of output amplifier
    adc_voltage_range:         [0., 16.]   # [V] Output DC Level
    adc_bit_resolution:        16
    full_well_capacity:        800000      # [e] Full-well capacity

#--------------------------------------------------------------
pipeline:
#--------------------------------------------------------------

  # photon -> photon
  photon_generation:

    # This should already be present in the PyEchelle simulations!
    # - name: shot_noise
    #   func: pyxel.models.photon_generation.shot_noise
    #   enabled: true

    - name: cosmix
      func: pyxel.models.charge_generation.cosmix
      enabled: true
      arguments:
        simulation_mode: cosmic_ray
        running_mode: stepsize
        particle_type: proton
        initial_energy: 100.       # [MeV]
        particles_per_second: 1    # [p/s] NOTE will be overwritten
        incident_angles:
        starting_position:
        spectrum_file: "inputfiles/proton_L2_solarMax_11mm_Shielding.txt"
        seed: 4321

  # photon -> charge
  charge_generation:

    # Load in PyEchelle image
    - name: load_charge
      func: pyxel.models.charge_generation.load_charge
      enabled: true
      arguments:
        filename: filename   # NOTE will be overwritten
        position: [0,0]
        align: "center"
        time_scale: 1        # NOTE will be overwritten

    # Apply QE from geometry class
    - name: photoelectrons
      func: pyxel.models.charge_generation.simple_conversion
      enabled: true
        
    # Dark current (simple model)
    - name: simple_dark_current
      func: pyxel.models.charge_generation.simple_dark_current
      enabled: true
      arguments:
        dark_rate: 0.01      # [e/pix/s]

        
  # charge -> pixel
  charge_collection:

    # NOTE this simple module is always needed!
    - name: simple_collection
      func: pyxel.models.charge_collection.simple_collection
      enabled: true

    - name: full_well
      func: pyxel.models.charge_collection.simple_full_well
      enabled: true


  # pixel -> pixel
  charge_transfer:

    # Charge transfer distortion (CTM)
    - name: cdm
      func: pyxel.models.charge_transfer.cdm
      enabled: true
      arguments:
        direction: parallel
        trap_release_times: [0.1, 1.]
        trap_densities: [0.307, 0.175]
        sigma: [1.e-15, 1.e-15] 
        beta: 1.0
        max_electron_volume: 1.62e-10   # [cm^2]
        transfer_period: 9.4722e-02     # [s]
        charge_injection: false



  # pixel -> signal
  charge_measurement:

    - name: simple_measurement
      func: pyxel.models.charge_measurement.simple_measurement
      enabled: true

    # Apply non-linearity using polynomials
    # Coefficient a,b,c [e-] -> S = a + bx+ cx2 (x is signal)
    - name: linearity
      func: pyxel.models.charge_measurement.output_node_linearity_poly
      enabled: true
      arguments:
        coefficients: [0, 1, 0.9]

        
  # signal -> image
  readout_electronics:

    - name: simple_amplifier
      func: pyxel.models.readout_electronics.simple_amplifier
      enabled: true
      
    - name: simple_adc
      func: pyxel.models.readout_electronics.simple_adc
      enabled: true
